-- Click Win Initial Schema
-- Migration: 001_initial_schema

-- Enable UUID generation
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============ Users ============
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  wallet_address VARCHAR(42) NOT NULL UNIQUE,
  nonce VARCHAR(64) NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'),
  referral_code VARCHAR(6) NOT NULL UNIQUE,
  referred_by UUID REFERENCES users(id) ON DELETE SET NULL,
  referral_bonus_pending BOOLEAN NOT NULL DEFAULT false,
  terms_accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_users_wallet ON users(wallet_address);
CREATE INDEX idx_users_referral_code ON users(referral_code);
CREATE INDEX idx_users_referred_by ON users(referred_by);

-- ============ Click Balances ============
CREATE TABLE IF NOT EXISTS click_balances (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  available_clicks INTEGER NOT NULL DEFAULT 0 CHECK (available_clicks >= 0),
  total_purchased INTEGER NOT NULL DEFAULT 0 CHECK (total_purchased >= 0),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============ Deposit Addresses ============
CREATE TABLE IF NOT EXISTS deposit_addresses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  address VARCHAR(42) NOT NULL UNIQUE,
  derivation_index INTEGER NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_deposit_addresses_address ON deposit_addresses(address);
CREATE INDEX idx_deposit_addresses_user ON deposit_addresses(user_id);

-- ============ Auctions ============
CREATE TABLE IF NOT EXISTS auctions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  prize_value NUMERIC(18,8) NOT NULL,
  prize_token VARCHAR(10) NOT NULL DEFAULT 'USDT',
  prize_description TEXT NOT NULL DEFAULT '',
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('PENDING','ACTIVE','CLOSING','ENDED','SETTLED','PAUSED','CANCELLED')),
  min_revenue_multiplier NUMERIC(5,2) NOT NULL DEFAULT 1.20,
  max_discount_pct NUMERIC(5,4) NOT NULL DEFAULT 0.5000,
  discount_per_click NUMERIC(10,6) NOT NULL DEFAULT 0.000100,
  timer_duration INTEGER NOT NULL DEFAULT 30000,
  click_count INTEGER NOT NULL DEFAULT 0,
  accumulated_discount NUMERIC(18,8) NOT NULL DEFAULT 0,
  revenue NUMERIC(18,8) NOT NULL DEFAULT 0,
  winner_id UUID REFERENCES users(id),
  final_discount NUMERIC(5,4),
  started_at TIMESTAMPTZ,
  ended_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_auctions_status ON auctions(status);
CREATE INDEX idx_auctions_winner ON auctions(winner_id);

-- ============ Click Ledger ============
CREATE TABLE IF NOT EXISTS click_ledger (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  auction_id UUID NOT NULL REFERENCES auctions(id),
  click_number INTEGER NOT NULL,
  discount_applied NUMERIC(10,6) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_click_ledger_auction ON click_ledger(auction_id);
CREATE INDEX idx_click_ledger_user ON click_ledger(user_id);
CREATE INDEX idx_click_ledger_auction_number ON click_ledger(auction_id, click_number);

-- ============ Deposits ============
CREATE TABLE IF NOT EXISTS deposits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  tx_hash VARCHAR(66) NOT NULL UNIQUE,
  token VARCHAR(10) NOT NULL CHECK (token IN ('BNB','USDT')),
  amount NUMERIC(18,8) NOT NULL,
  confirmations INTEGER NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('PENDING','CONFIRMED','CREDITED','FAILED')),
  deposit_address VARCHAR(42) NOT NULL,
  clicks_credited INTEGER NOT NULL DEFAULT 0,
  is_first_deposit BOOLEAN NOT NULL DEFAULT false,
  detected_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  confirmed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_deposits_user ON deposits(user_id);
CREATE INDEX idx_deposits_tx_hash ON deposits(tx_hash);
CREATE INDEX idx_deposits_status ON deposits(status);
CREATE INDEX idx_deposits_address ON deposits(deposit_address);

-- ============ Referral Rewards ============
CREATE TABLE IF NOT EXISTS referral_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID NOT NULL REFERENCES users(id),
  referred_id UUID NOT NULL REFERENCES users(id),
  deposit_id UUID NOT NULL REFERENCES deposits(id),
  clicks_earned INTEGER NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('CREDITED','PENDING')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_referral_rewards_referrer ON referral_rewards(referrer_id);
CREATE INDEX idx_referral_rewards_referred ON referral_rewards(referred_id);

-- ============ Payouts ============
CREATE TABLE IF NOT EXISTS payouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  auction_id UUID NOT NULL REFERENCES auctions(id),
  winner_id UUID NOT NULL REFERENCES users(id),
  gross_amount NUMERIC(18,8) NOT NULL,
  net_amount NUMERIC(18,8) NOT NULL,
  platform_fee NUMERIC(18,8) NOT NULL,
  applied_discount NUMERIC(5,4) NOT NULL,
  tx_hash VARCHAR(66),
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('PENDING','PROCESSING','COMPLETED','FAILED')),
  executed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_payouts_auction ON payouts(auction_id);
CREATE INDEX idx_payouts_winner ON payouts(winner_id);

-- ============ Audit Logs ============
CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type VARCHAR(100) NOT NULL,
  actor VARCHAR(100) NOT NULL,
  payload JSONB NOT NULL DEFAULT '{}',
  ip_address VARCHAR(45),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_event ON audit_logs(event_type);
CREATE INDEX idx_audit_logs_actor ON audit_logs(actor);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at);

-- ============ Migrations Tracking ============
CREATE TABLE IF NOT EXISTS _migrations (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL UNIQUE,
  applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============ Updated_at Trigger ============
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER trigger_click_balances_updated_at
  BEFORE UPDATE ON click_balances
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- ============ Derivation Index Sequence ============
CREATE SEQUENCE IF NOT EXISTS deposit_address_index_seq START WITH 1;
